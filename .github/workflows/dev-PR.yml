name: üîê PR Gate ‚Äî Build, SAST, SCA

on:
  pull_request:
    branches: [ master ]
    types: [opened, synchronize, reopened]
  workflow_dispatch: {}

permissions:
  contents: read
  security-events: write   # si tu uploade du SARIF (optionnel)

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build_and_test:
    name: Build & Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      - name: Install deps (CI)
        run: npm ci
      - name: Build (if exists)
        run: |
          if npm run | grep -q "^  build"; then npm run build; else echo "no build script"; fi
      - name: Unit tests
        run: |
          if npm run | grep -q "^  test"; then npm test --silent; else echo "no tests"; fi

  sast:
    name: SAST (Semgrep)
    runs-on: ubuntu-latest
    needs: build_and_test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install semgrep
        run: python -m pip install --user pipx && python -m pipx ensurepath && pipx install semgrep
      - name: Run Semgrep (OWASP Top 10)
        run: semgrep --config p/owasp-top-ten --error --timeout 120 .

  sca:
    name: SCA (Trivy)
    runs-on: ubuntu-latest
    needs: build_and_test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: ${{ runner.os }}-trivy-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-trivy-
      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget apt-transport-https gnupg
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo gpg --dearmor -o /usr/share/keyrings/trivy.gpg
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb stable main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update -y && sudo apt-get install -y trivy
      - name: Trivy FS scan (HIGH,CRITICAL)
        run: trivy fs --security-checks vuln --severity HIGH,CRITICAL --exit-code 1 --ignore-unfixed .

  # DAST optionnel (comment√© car hors p√©rim√®tre d√©ploiement)
  # dast:
  #   name: DAST (OWASP ZAP)
  #   runs-on: ubuntu-latest
  #   needs: build_and_test
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Start Juice Shop
  #       run: |
  #         npm ci
  #         npm start & sleep 15
  #     - name: ZAP Baseline
  #       run: docker run --network host -t owasp/zap2docker-stable zap-baseline.py -t http://localhost:3000 -r zap-report.html
  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: zap-report
  #         path: zap-report.html
